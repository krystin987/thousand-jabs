--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Alpha only.
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
if select(4, GetBuildInfo()) < 80000 then
    return
end

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Module init.
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
local addonName, tj, _ = ...
local LibStub = LibStub
local TJ = tj.TJ
local Callbacks = tj.Callbacks
local Config = tj.Config
local UI = tj.UI

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Locals
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
local GetTime = GetTime
local mmin = math.min

local TableCache = LibStub('LibTJTableCache-8.0')

local slowUpdateSpeed = 0.75
local fastUpdateSpeed = 0.2
local nextUpdateTime = 0

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Sandbox
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
LibStub('LibTJSandbox-8.0'):Use(addonName)

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Main loop
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

function TJ:QueueUpdate()
    local now = GetTime()
    nextUpdateTime = mmin(now + fastUpdateSpeed, nextUpdateTime)
end

function TJ:QueueProfileReload(forceNow)
    if forceNow then nextUpdateTime = 0 end
end

function TJ:PerformUpdate()
    self:AddDebugLog('zzz: %.3f', GetTime())
end

Callbacks.Register('MainLoop', 'TIME_SLICE', function()
    local now = GetTime()
    if nextUpdateTime <= now then
        nextUpdateTime = now + slowUpdateSpeed
        TJ:ClearDebugLog()
        TJ:PerformUpdate()
        TJ:UpdateDebugLog()
    end
end)

Callbacks.Register('MainConfigUpdate', 'CONFIG_CHANGED', function()
    slowUpdateSpeed = Config:Get('slowUpdateSpeed')
    fastUpdateSpeed = Config:Get('fastUpdateSpeed')
end)
