--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Alpha only.
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
if select(4, GetBuildInfo()) < 80000 then
    return
end

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Module init.
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
local addonName, TJ, _ = ...
local LibStub, CT, RT, Callbacks, Events, Config, UI = LibStub, CT, RT, TJ.Callbacks, TJ.Events, TJ.Config, TJ.UI
local DBG = function(...) TJ:AddDebugLog(...) end

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Locals
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
local GetTime = GetTime
local mmin = math.min

local PRF = LibStub('LibTJProfiling-8.0')

local nextUpdateTime = 0

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Config values
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

local slowUpdateSpeed = 0.75
local fastUpdateSpeed = 0.2

Callbacks.Register('ExecutorConfigUpdate', 'CONFIG_CHANGED', function()
    TJ:DevPrint('CONFIG_CHANGED(ExecutorConfigUpdate)')
    slowUpdateSpeed = Config:Get('slowUpdateSpeed')
    fastUpdateSpeed = Config:Get('fastUpdateSpeed')
end)

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Sandbox
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
LibStub('LibTJSandbox-8.0'):Use(addonName)

--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- Main loop
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------

function TJ:QueueUpdate()
    local now = GetTime()
    nextUpdateTime = mmin(now + fastUpdateSpeed, nextUpdateTime)
end

function TJ:QueueProfileReload(forceNow)
    if forceNow then nextUpdateTime = 0 end
end

function TJ:PerformUpdate()
end
PRF:ProfileFunction(TJ, 'PerformUpdate')

Callbacks.Register('MainLoop', 'TIME_SLICE', function()
    local now = GetTime()
    if nextUpdateTime <= now then
        nextUpdateTime = now + slowUpdateSpeed
        TJ:ClearDebugLog()
        DBG(PRF:GetProfilingString())
        TJ:PerformUpdate()
        TJ:UpdateDebugLog()
    end
end)

function TJ:COMBAT_LOG_EVENT_UNFILTERED(...)
    self:QueueUpdate()
end
PRF:ProfileFunction(TJ, 'COMBAT_LOG_EVENT_UNFILTERED')
Events.Register(TJ, 'COMBAT_LOG_EVENT_UNFILTERED')
